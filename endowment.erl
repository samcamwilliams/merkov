-module(endowment).
-export([sim/0, sim/2, sim_many/3]).
-export([test_pessimism/0, test_volatility/0, pessimism_volatility_matrix/2, csv/1]).

-define(TEST_RUNS, 20).

%% Model the outcomes for the network if the future is only X% as effective at reducing storage costs as
%% the past. This test outputs the percentage of runs that survive 10,000 years 
test_pessimism() ->
	csv(
		lists:map(
			fun(Pessimism) ->
				Results = sim_many(Pessimism, 0, ?TEST_RUNS),
				[
					Pessimism,
					collate(Results, survival_rate),
					collate(Results, avg_years),
					collate(Results, avg_burn)
				]
			end,
			[ (X / 100) || X <- lists:seq(1, 100) ]
		)
	).

%% Model the outcomes for the network under different levels of endowment value volatility. Outputs the 
%% percentage of runs that survive under various % of yearly change in token price. This test remains 
%% neutral on price direction (there are an equal number and size of prices increases to decreases on average).
test_volatility() ->
	csv(
		lists:map(
			fun(Volatility) ->
				Results = sim_many(1, Volatility, ?TEST_RUNS),
				[
					Volatility,
					collate(Results, survival_rate),
					collate(Results, avg_years),
					collate(Results, avg_burn)
				]
			end,
			[ (X / 100) || X <- lists:seq(1, 100) ]
		)
	).

%% Generate a matrix of values that relate the outcomes on a given metric to changes in volatility and pessimism.
pessimism_volatility_matrix(Metric, SubDivs) ->
	csv(
		[
			[
				collate(sim_many(X / SubDivs, Y / SubDivs, ?TEST_RUNS), Metric)
			||
				Y <- lists:seq(0, SubDivs)
			]
		||
			X <- lists:seq(0, SubDivs)
		]
	).

csv([]) -> ok;
csv([Fields|Rest]) ->
	io:format(lists:flatten([ "~w," || _ <- Fields ]) ++ "~n", Fields),
	csv(Rest).

%% Extract a 'success' metric from a series of runs of the simulation.
collate(Results, survival_rate) ->
	length([ survived || {survived, _} <- Results ]) / length(Results);
collate(Results, avg_years) ->
	avg([ TerminalYrs || {_, {TerminalYrs, _, _}} <- Results ]);
collate(Results, avg_burn) ->
	avg([ (Endowment / 200) || {_, {_, Endowment, _}} <- Results ]).

sim_many(Pessimism, Volatility, TestRuns) ->
	[ sim(Pessimism, Volatility) || _ <- lists:seq(1, TestRuns) ].

sim() -> sim(0, 0).
sim(Pessimism, Volatility) ->
	rand:seed(default),
	Prices = apply_pessimism(Pessimism, real_yearly_storage_prices()),
	lists:last(markov:run(
		step,
		% In this model starting yearly storage prices are normalized to 1. We take 200 years worth 
		% from the user at the start to seed the endowment. Replicas, electricity, and operational
		% costs are also expressed in the single 'all in' storage price in this model.
		{0, 200, 1},
		[ {step, 1, generate_adjustment(YearlyAdjustment)} || YearlyAdjustment <- Prices ] ++
		[ {apply_volatility, 1,
		  	fun({Yrs, Endowment, Price}) ->
				{step,
					{Yrs,
					(Endowment - (Endowment * Volatility)) +
						(rand:uniform_real() * mult:getCorrespondingMultiplier(Volatility) * (Endowment * Volatility)),
					Price}
				}
			end}
		]
	)).

generate_adjustment(Adjustment) ->
	fun(Params = {_Yrs, Endowment, _Price}) when Endowment =< 0 -> {terminated, Params};
	   (Params = {Yrs, _Endowment, _Price}) when Yrs >= 10000 -> {survived, Params};
	   ({Yrs, Endowment, Price}) -> {apply_volatility, {Yrs + 1, Endowment - Price, Price * Adjustment}}
	end.

calculate_price_changes([Y0, Y1 | Rest]) -> [ (Y1 / Y0) | calculate_price_changes([Y1|Rest]) ];
calculate_price_changes([_]) -> [].

%% Optionally apply a pessimistic overlay to storage cost decline values (range: 0 -> 1).
%% Pessimism is defined as the % of all real decreases in cost declines that should be applied.
%% For example, a value of 0.1 implies that only 10% of a real storage cost decline for a year 
%% should actually be simulated -- 90% of the downward change should be ignored.
%% This creates a way to ask questions like: What if we are only x% as effective at building 
%% better drives in the future than we were in the past?
apply_pessimism(_, []) -> [];
apply_pessimism(Pessimism, [ PriceChange | Rest ]) when PriceChange >= 1 ->
	[ 1 + ((1 - PriceChange) * Pessimism) | apply_pessimism(Pessimism, Rest) ];
apply_pessimism(Pessimism, [ PriceChange | Rest ]) ->
	[ 1 - ((1 - PriceChange) * Pessimism) | apply_pessimism(Pessimism, Rest) ].

real_yearly_storage_prices() ->
	Prices = hdd_prices(),
	Years = lists:uniq(([ Year || {Year, _} <- Prices ])),
	calculate_price_changes(
		lists:map(
			fun(Year) ->
				avg([ Price || {XYear, Price} <- Prices, Year == XYear ])
			end,
			Years
		)
	).

avg(List) ->
	lists:sum(List) / length(List).

hdd_prices() ->
	[
		{1980,7.25415311000},
		{1980,8.65177245283},
		{1981,25.68209182399},
		{1981,12.32697117047},
		{1981,16.48317513568},
		{1981,10.62597870857},
		{1981,10.32980351854},
		{1981,10.00568096555},
		{1981,6.53907141010},
		{1981,5.14652544540},
		{1981,4.62157689771},
		{1982,8.61343934489},
		{1983,10.35697615424},
		{1983,8.75591860339},
		{1983,6.09722172546},
		{1983,5.55781702909},
		{1983,5.18661901926},
		{1983,4.07616130089},
		{1983,3.66565195332},
		{1984,8.53945484966},
		{1984,8.15354582478},
		{1984,5.08375088417},
		{1984,4.73858905943},
		{1984,4.10668294083},
		{1984,3.86445660661},
		{1984,3.45406521018},
		{1984,3.36497543852},
		{1984,8.44810091149},
		{1984,7.92317186910},
		{1984,5.93727559775},
		{1984,5.49920150913},
		{1984,4.93263743347},
		{1984,4.45707260776},
		{1984,4.23079091268},
		{1984,3.71641501557},
		{1984,3.13189535198},
		{1984,2.81825320653},
		{1984,2.07001522070},
		{1985,1.82179705945},
		{1987,2.29019541110},
		{1987,1.51425651412},
		{1987,1.12644030913},
		{1988,0.99318912104},
		{1988,0.81281284029},
		{1988,0.65974018900},
		{1988,0.72726126467},
		{1988,0.38483648917},
		{1989,1.26486973741},
		{1989,0.85253517038},
		{1989,0.28200494163},
		{1990,0.20989836500},
		{1991,0.16202449644},
		{1992,0.09189319905},
		{1993,0.04560562291},
		{1994,0.02150309319},
		{1995,0.01909891786},
		{1995,0.01962945468},
		{1995,0.01793780081},
		{1995,0.02176709878},
		{1995,0.02750675199},
		{1995,0.01998596045},
		{1995,0.01902800769},
		{1995,0.01429998015},
		{1995,0.01604798069},
		{1995,0.01446214536},
		{1996,0.00617676497},
		{1996,0.00546947232},
		{1996,0.00535007610},
		{1996,0.00424737576},
		{1996,0.00352619197},
		{1997,0.00366494149},
		{1997,0.00297712909},
		{1997,0.00281787133},
		{1997,0.00303793126},
		{1997,0.00240684956},
		{1997,0.00231308519},
		{1997,0.00229842221},
		{1997,0.00201296756},
		{1997,0.00211577260},
		{1997,0.00198792286},
		{1997,0.00193763983},
		{1997,0.00190685446},
		{1997,0.00183141041},
		{1997,0.00159275735},
		{1997,0.00148304258},
		{1997,0.00186111282},
		{1997,0.00180972083},
		{1997,0.00176804217},
		{1997,0.00172504444},
		{1997,0.00167535227},
		{1998,0.00170316755},
		{1998,0.00166484943},
		{1998,0.00152617084},
		{1998,0.00147523751},
		{1998,0.00137243408},
		{1998,0.00135945395},
		{1998,0.00148145472},
		{1998,0.00147144788},
		{1998,0.00127009757},
		{1998,0.00103867595},
		{1998,0.00130514887},
		{1998,0.00128287494},
		{1998,0.00111201711},
		{1998,0.00110267176},
		{1998,0.00105538040},
		{1998,0.00124058894},
		{1998,0.00119797652},
		{1998,0.00107604806},
		{1998,0.00101855863},
		{1998,0.00095522860},
		{1998,0.00130759110},
		{1998,0.00109516491},
		{1998,0.00104827908},
		{1998,0.00092929799},
		{1998,0.00094966575},
		{1998,0.00095264757},
		{1998,0.00083129364},
		{1998,0.00085184707},
		{1998,0.00090911299},
		{1998,0.00085254402},
		{1998,0.00080415089},
		{1998,0.00079260717},
		{1998,0.00078871707},
		{1998,0.00081938102},
		{1998,0.00069293948},
		{1998,0.00077132785},
		{1998,0.00074395064},
		{1998,0.00076540982},
		{1998,0.00069437415},
		{1998,0.00069836924},
		{1998,0.00061816349},
		{1999,0.00062247924},
		{1999,0.00054194148},
		{1999,0.00052224809},
		{1999,0.00043722475},
		{1999,0.00049049452},
		{1999,0.00047554203},
		{1999,0.00045229833},
		{1999,0.00044884182},
		{1999,0.00043845700},
		{1999,0.00043509410},
		{1999,0.00044555568},
		{1999,0.00037902094},
		{1999,0.00037049876},
		{1999,0.00033346902},
		{1999,0.00039026748},
		{1999,0.00036966586},
		{1999,0.00035327411},
		{1999,0.00024741919},
		{1999,0.00029827955},
		{1999,0.00027975630},
		{1999,0.00027195353},
		{1999,0.00027079009},
		{1999,0.00024214934},
		{1999,0.00029065000},
		{1999,0.00028552876},
		{1999,0.00027528101},
		{1999,0.00027412800},
		{1999,0.00023581769},
		{1999,0.00022079894},
		{1999,0.00021480154},
		{1999,0.00020885356},
		{1999,0.00020547555},
		{1999,0.00018831535},
		{2000,0.00024631444},
		{2000,0.00021044893},
		{2000,0.00020835925},
		{2000,0.00020752163},
		{2000,0.00020546041},
		{2000,0.00020219023},
		{2000,0.00019284340},
		{2000,0.00019208042},
		{2000,0.00018647982},
		{2000,0.00017248011},
		{2000,0.00014417261},
		{2000,0.00018789117},
		{2000,0.00018000951},
		{2000,0.00017693880},
		{2000,0.00017389174},
		{2000,0.00017204645},
		{2000,0.00016786746},
		{2000,0.00016722857},
		{2000,0.00016193454},
		{2000,0.00016016230},
		{2000,0.00015724716},
		{2000,0.00015550577},
		{2000,0.00014918702},
		{2000,0.00014520194},
		{2000,0.00014238549},
		{2000,0.00014185960},
		{2000,0.00013342267},
		{2000,0.00017123636},
		{2000,0.00013806009},
		{2000,0.00012861076},
		{2000,0.00016268762},
		{2000,0.00013767378},
		{2000,0.00012390280},
		{2000,0.00011133294},
		{2000,0.00011972189},
		{2000,0.00011820100},
		{2000,0.00011341920},
		{2000,0.00010052088},
		{2000,0.00008684717},
		{2000,0.00012409414},
		{2000,0.00010860562},
		{2000,0.00010265480},
		{2000,0.00009791995},
		{2000,0.00009502692},
		{2000,0.00007911021},
		{2000,0.00007714722},
		{2000,0.00007635620},
		{2000,0.00007494083},
		{2000,0.00008232164},
		{2000,0.00007557904},
		{2000,0.00007168718},
		{2001,0.00007558738},
		{2001,0.00007481754},
		{2001,0.00007045305},
		{2001,0.00007647101},
		{2001,0.00006630652},
		{2001,0.00005814415},
		{2001,0.00006901475},
		{2001,0.00006656206},
		{2001,0.00006543621},
		{2001,0.00005879042},
		{2001,0.00006340687},
		{2001,0.00006320084},
		{2001,0.00005722398},
		{2001,0.00004374661},
		{2001,0.00002956495},
		{2001,0.00004504296},
		{2002,0.00004234451},
		{2002,0.00003623558},
		{2002,0.00002587005},
		{2002,0.00002792902},
		{2002,0.00003618340},
		{2002,0.00002504560},
		{2002,0.00001995434},
		{2002,0.00002488894},
		{2002,0.00002749365},
		{2002,0.00002473423},
		{2002,0.00002551442},
		{2003,0.00002448652},
		{2003,0.00001438175},
		{2003,0.00001820497},
		{2003,0.00001673869},
		{2003,0.00001509386},
		{2003,0.00001420676},
		{2003,0.00001323185},
		{2003,0.00001291315},
		{2004,0.00001796834},
		{2004,0.00001791434},
		{2004,0.00001565110},
		{2004,0.00001441107},
		{2004,0.00001290388},
		{2004,0.00001259182},
		{2004,0.00001128089},
		{2004,0.00001106618},
		{2004,0.00001040053},
		{2004,0.00000631218},
		{2004,0.00000647353},
		{2005,0.00000672359},
		{2005,0.00000572077},
		{2005,0.00000463464},
		{2005,0.00000622090},
		{2006,0.00000443068},
		{2006,0.00000530153},
		{2006,0.00000493391},
		{2006,0.00000386556},
		{2007,0.00000350412},
		{2007,0.00000384358},
		{2008,0.00000235187},
		{2008,0.00000234522},
		{2009,0.00000060631},
		{2010,0.00000063311},
		{2010,0.00000063133},
		{2010,0.00000068711},
		{2010,0.00000064237},
		{2010,0.00000046976},
		{2010,0.00000046846},
		{2010,0.00000042470},
		{2010,0.00000042353},
		{2010,0.00000038013},
		{2011,0.00000033696},
		{2011,0.00000033604},
		{2011,0.00000033513},
		{2011,0.00000030664},
		{2011,0.00000033331},
		{2011,0.00000033241},
		{2012,0.00000065142},
		{2012,0.00000057941},
		{2012,0.00000053252},
		{2012,0.00000049327},
		{2012,0.00000043538},
		{2012,0.00000040887},
		{2013,0.00000044857},
		{2013,0.00000037987},
		{2013,0.00000033800},
		{2013,0.00000035062},
		{2013,0.00000034943},
		{2013,0.00000036220},
		{2013,0.00000036126},
		{2013,0.00000034670},
		{2013,0.00000034341},
		{2013,0.00000031862},
		{2013,0.00000031779},
		{2014,0.00000029082},
		{2014,0.00000029008},
		{2014,0.00000028933},
		{2014,0.00000028830},
		{2014,0.00000027450},
		{2015,0.00000026052},
		{2015,0.00000025518},
		{2015,0.00000022028},
		{2015,0.00000024612},
		{2015,0.00000023234},
		{2015,0.00000022403},
		{2015,0.00000023117},
		{2015,0.00000023060},
		{2015,0.00000024919},
		{2015,0.00000021339},
		{2016,0.00000023780},
		{2016,0.00000021083},
		{2016,0.00000022447},
		{2016,0.00000020865},
		{2016,0.00000022648},
		{2016,0.00000021395},
		{2016,0.00000020597},
		{2016,0.00000021906},
		{2016,0.00000020216},
		{2017,0.00000019471},
		{2017,0.00000017866},
		{2017,0.00000019568},
		{2017,0.00000016076},
		{2017,0.00000016487},
		{2017,0.00000017200},
		{2017,0.00000016041},
		{2017,0.00000015219},
		{2018,0.00000014944},
		{2018,0.00000014676},
		{2018,0.00000013759},
		{2018,0.00000013509},
		{2018,0.00000013340},
		{2018,0.00000014089},
		{2018,0.00000013642},
		{2018,0.00000013494},
		{2018,0.00000013338},
		{2019,0.00000013124},
		{2019,0.00000013140},
		{2019,0.00000012465},
		{2019,0.00000009728},
		{2019,0.00000010901},
		{2016,0.00000023780},
		{2016,0.00000021083},
		{2016,0.00000014883},
		{2016,0.00000013910},
		{2016,0.00000015179},
		{2016,0.00000014413},
		{2016,0.00000013946},
		{2016,0.00000014905},
		{2016,0.00000013821},
		{2017,0.00000013374},
		{2017,0.00000012327},
		{2017,0.00000013562},
		{2017,0.00000011190},
		{2017,0.00000011525},
		{2017,0.00000012073},
		{2017,0.00000011305},
		{2017,0.00000010768},
		{2018,0.00000010614},
		{2018,0.00000010463},
		{2018,0.00000009846},
		{2018,0.00000009702},
		{2018,0.00000009615},
		{2018,0.00000010189},
		{2018,0.00000009899},
		{2018,0.00000009824},
		{2018,0.00000009743},
		{2019,0.00000009617},
		{2019,0.00000009658},
		{2019,0.00000009190},
		{2019,0.00000007194}
	].
